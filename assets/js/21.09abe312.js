(window.webpackJsonp=window.webpackJsonp||[]).push([[21],{424:function(e,s,n){"use strict";n.r(s);var a=n(2),t=Object(a.a)({},(function(){var e=this,s=e._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[s("blockquote",[s("p",[s("a",{attrs:{href:"https://www.mongodb.com/docs/manual/core/gridfs/",target:"_blank",rel:"noopener noreferrer"}},[e._v("GridFS — MongoDB Manual"),s("OutboundLink")],1)])]),e._v(" "),s("blockquote",[s("p",[e._v("GridFS 用于存储和恢复那些超过16M（BSON文件限制）的文件(如：图片、音频、视频等)。\nGridFS 也是文件存储的一种方式，但是它是存储在MonoDB的集合中。\nGridFS 会将大文件对象分割成多个小的"),s("code",[e._v("chunk")]),e._v(",每个"),s("code",[e._v("chunk")]),e._v("将作为MongoDB的一个文档(document)被存储在"),s("code",[e._v("chunks")]),e._v("集合中。")])]),e._v(" "),s("p",[e._v("GridFS 将文件存储在两个集合中：")]),e._v(" "),s("ul",[s("li",[s("code",[e._v("chunks")]),e._v("存储二进制块。有关详细信息，请参阅"),s("code",[e._v("块集合")])]),e._v(" "),s("li",[s("code",[e._v("files")]),e._v("存储文件的元数据。有关详细信息，请参阅"),s("code",[e._v("文件集合")])])]),e._v(" "),s("p",[e._v("GridFS 通过将集合的存储桶名称作为前缀，将集合放在公共存储桶中。默认情况下，GridFS 使用两个集合，其存储桶名为 ："),s("code",[e._v("fs")])]),e._v(" "),s("ul",[s("li",[s("code",[e._v("fs.files")])])]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('{\n  "_id" : <ObjectId>,\n  "length" : <num>,\n  "chunkSize" : <num>,\n  "uploadDate" : <timestamp>,\n  "md5" : <hash>,\n  "filename" : <string>,\n  "contentType" : <string>,\n  "aliases" : <string array>,\n  "metadata" : <any>,\n}\n')])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br"),s("span",{staticClass:"line-number"},[e._v("11")]),s("br")])]),s("ul",[s("li",[s("code",[e._v("fs.chunks")])])]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('{\n  "_id" : <ObjectId>,\n  "files_id" : <ObjectId>,\n  "n" : <num>,\n  "data" : <binary>\n}\n')])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br")])]),s("h1",{attrs:{id:"gridfs使用"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#gridfs使用"}},[e._v("#")]),e._v(" GridFS使用")]),e._v(" "),s("h3",{attrs:{id:"使用shell命令"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#使用shell命令"}},[e._v("#")]),e._v(" 使用shell命令")]),e._v(" "),s("blockquote",[s("p",[e._v("MongoDB 提供 "),s("code",[e._v("mingofiles")]),e._v(" 工具，可以使用命令行来操作GridFS。四个主要命令，分别为：\n"),s("code",[e._v("put")]),e._v("  存储命令\n"),s("code",[e._v("get")]),e._v("  获取命令\n"),s("code",[e._v("list")]),e._v("  列表命令\n"),s("code",[e._v("delete")]),e._v("  删除命令")])]),e._v(" "),s("div",{staticClass:"language-shell line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# 存储文件 (执行后会在数据库中就会多出2个集合，它们存储了GridFS文件系统的所有文件信息)")]),e._v("\n- mongofiles "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("-d")]),e._v(" 数据库名字 "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("-l")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"要上传的文件的完整路径名"')]),e._v(" put "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"上传后的文件名"')]),e._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# 获取文件 (如果不写-l以及后面的路径参数，则保存到当前位置。)")]),e._v("\n- mongofiles "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("-d")]),e._v(" 数据库名字 "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("-l")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"将文件保存在本地的完整路径名"')]),e._v(" get "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"GridFS文件系统中的文件名"')]),e._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("#列表文件")]),e._v("\n- mongofiles "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("-d")]),e._v(" 数据库名字 list\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("#删除文件")]),e._v("\n- mongofiles "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("-d")]),e._v(" 数据库名字 delete "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('" 文件名 "')]),e._v("\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br"),s("span",{staticClass:"line-number"},[e._v("11")]),s("br")])]),s("h3",{attrs:{id:"使用api"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#使用api"}},[e._v("#")]),e._v(" 使用API")]),e._v(" "),s("blockquote",[s("p",[e._v("MongoDB支持多种编程语言驱动。比如c、java、C#、NodeJS等。因此可以使用这些语言MongoDB驱动API操作，扩展GridFS。")])]),e._v(" "),s("p",[e._v("以"),s("code",[e._v("SpringBoot")]),e._v("为例：\n在 "),s("a",{attrs:{href:"https://www.jianshu.com/p/744bee7b6094",target:"_blank",rel:"noopener noreferrer"}},[e._v("上次Mongo测试基础上"),s("OutboundLink")],1),e._v(" "),s("a",{attrs:{href:"http://mongodb.github.io/mongo-java-driver/3.4/driver/tutorials/gridfs/",target:"_blank",rel:"noopener noreferrer"}},[e._v("官方文档教程"),s("OutboundLink")],1)]),e._v(" "),s("h2",{attrs:{id:"上传文件"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#上传文件"}},[e._v("#")]),e._v(" 上传文件")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('    //文件操作\n    @Autowired\n    GridFsTemplate gridFsTemplate;\n    @Test\n    public void testUpload() throws FileNotFoundException {\n\n        File file = new File("D:\\\\Test\\\\demo.zip");\n        // 获取文件名\n        String fileName=file.getName().substring(0,file.getName().lastIndexOf("."));\n        // 获取文件后缀\n        String contentType = file.getName().substring(file.getName().lastIndexOf(".") + 1, file.getName().length());\n        // 获取文件流\n        FileInputStream fileInputStream = new FileInputStream(file);\n        // 上传 return "_id"\n        ObjectId objectId = gridFsTemplate.store(fileInputStream, file.getName(),contentType);\n\n        System.out.println(objectId);\n    }\n')])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br"),s("span",{staticClass:"line-number"},[e._v("11")]),s("br"),s("span",{staticClass:"line-number"},[e._v("12")]),s("br"),s("span",{staticClass:"line-number"},[e._v("13")]),s("br"),s("span",{staticClass:"line-number"},[e._v("14")]),s("br"),s("span",{staticClass:"line-number"},[e._v("15")]),s("br"),s("span",{staticClass:"line-number"},[e._v("16")]),s("br"),s("span",{staticClass:"line-number"},[e._v("17")]),s("br"),s("span",{staticClass:"line-number"},[e._v("18")]),s("br")])]),s("h4",{attrs:{id:"自定义桶名称"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#自定义桶名称"}},[e._v("#")]),e._v(" 自定义桶名称")]),e._v(" "),s("p",[e._v("在 "),s("code",[e._v("config")]),e._v(" 包下创建 "),s("code",[e._v("MongoConfig")]),e._v(" 类")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('@Configuration\npublic class MongoConfig {\n    @Bean\n    public GridFsTemplate gridFsTemplate(MongoDatabaseFactory dbFactory, MongoConverter converter) {\n        return new GridFsTemplate(dbFactory, converter, "pictureFs");\n    }\n}\n')])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br")])]),s("p",[e._v("再在测试类中"),s("code",[e._v("上传文件")]),e._v(",就上传到了"),s("code",[e._v("pictureFs")]),e._v("桶中")]),e._v(" "),s("h2",{attrs:{id:"上传文件-法2"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#上传文件-法2"}},[e._v("#")]),e._v(" 上传文件 -法2")]),e._v(" "),s("blockquote",[s("p",[e._v("使用GridFSBucket.uploadFromStream 方法\n可以使用 GridFSUploadOptions 来配置块大小或包含其他元数据。")])]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('    @Test void testUpload2(){\n        GridFSBucket bucket=GridFSBuckets.create(mongoTemplate.getDb(),"fs");\n        try {\n            File file = new File("D:\\\\Test\\\\test.zip");\n            // 获取文件名\n            String fileName=file.getName().substring(0,file.getName().lastIndexOf("."));\n            // 获取文件后缀\n            String contentType = file.getName().substring(file.getName().lastIndexOf(".") + 1);\n            // 获取文件流\n            InputStream streamToUploadFrom = new FileInputStream(file);\n            // 配置块大小 或 包含其他元数据\n            GridFSUploadOptions options = new GridFSUploadOptions()\n                    .chunkSizeBytes(358400)\n                    .metadata(new Document("type", contentType));\n\n            ObjectId fileId = bucket.uploadFromStream(fileName, streamToUploadFrom, options);\n\n            System.out.println("文件上传成功-"+fileId);\n        } catch (FileNotFoundException e){\n            System.out.println("FileNotFoundException:" + e.getMessage());\n        }\n    }\n')])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br"),s("span",{staticClass:"line-number"},[e._v("11")]),s("br"),s("span",{staticClass:"line-number"},[e._v("12")]),s("br"),s("span",{staticClass:"line-number"},[e._v("13")]),s("br"),s("span",{staticClass:"line-number"},[e._v("14")]),s("br"),s("span",{staticClass:"line-number"},[e._v("15")]),s("br"),s("span",{staticClass:"line-number"},[e._v("16")]),s("br"),s("span",{staticClass:"line-number"},[e._v("17")]),s("br"),s("span",{staticClass:"line-number"},[e._v("18")]),s("br"),s("span",{staticClass:"line-number"},[e._v("19")]),s("br"),s("span",{staticClass:"line-number"},[e._v("20")]),s("br"),s("span",{staticClass:"line-number"},[e._v("21")]),s("br"),s("span",{staticClass:"line-number"},[e._v("22")]),s("br")])]),s("h2",{attrs:{id:"查询文件"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#查询文件"}},[e._v("#")]),e._v(" 查询文件")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('    //文件查询\n    @Test\n    public void testFind(){\n        // findAll\n        // 可以为 GridFSBuckets.create() 方法指定存储桶名称\n        GridFSBucket bucket=GridFSBuckets.create(mongoTemplate.getDb(),"bucketName");\n        bucket.find().forEach(e-> System.out.println(e.getFilename()));\n    }\n')])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br")])]),s("p",[e._v("提供设置过滤器来限制返回的结果")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('bucket.find(Filters.eq("filename","测试文件")).forEach(e-> System.out.println(e.getFilename()));\n')])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br")])]),s("h2",{attrs:{id:"下载文件"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#下载文件"}},[e._v("#")]),e._v(" 下载文件")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('    @Test \n    public void testDownload() throws IOException{\n        ObjectId fileId= new ObjectId("626d45071aa7187f36380ee9");\n        GridFSBucket bucket=GridFSBuckets.create(mongoTemplate.getDb(),"fs");\n        try {\n            // 使用输出流 设置要保存的路径\n            FileOutputStream streamToDownloadTo = new FileOutputStream("D:\\\\Test\\\\downTest.zip");\n            // 通过Id下载文件\n            bucket.downloadToStream(fileId, streamToDownloadTo);\n            // 关闭输出流\n            streamToDownloadTo.close();\n\n            System.out.println(streamToDownloadTo);\n            \n        } catch (IOException e) {\n            System.out.println("IOException:" + e.getMessage());\n        }\n    }\n')])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br"),s("span",{staticClass:"line-number"},[e._v("11")]),s("br"),s("span",{staticClass:"line-number"},[e._v("12")]),s("br"),s("span",{staticClass:"line-number"},[e._v("13")]),s("br"),s("span",{staticClass:"line-number"},[e._v("14")]),s("br"),s("span",{staticClass:"line-number"},[e._v("15")]),s("br"),s("span",{staticClass:"line-number"},[e._v("16")]),s("br"),s("span",{staticClass:"line-number"},[e._v("17")]),s("br"),s("span",{staticClass:"line-number"},[e._v("18")]),s("br")])]),s("h2",{attrs:{id:"重命名文件"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#重命名文件"}},[e._v("#")]),e._v(" 重命名文件")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('    @Test\n    public void testRename(){\n        ObjectId fileId= new ObjectId("626d45071aa7187f36380ee9");\n        GridFSBucket bucket=GridFSBuckets.create(mongoTemplate.getDb(),"fs");\n        bucket.rename(fileId,"Test");\n    }\n')])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br")])]),s("h2",{attrs:{id:"删除文件"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#删除文件"}},[e._v("#")]),e._v(" 删除文件")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('    public void deleteRename(){\n        ObjectId fileId= new ObjectId("626ba621ac6c406b9208cfb6");\n        GridFSBucket bucket=GridFSBuckets.create(mongoTemplate.getDb(),"fs");\n        bucket.delete(fileId);\n    }\n')])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br")])]),s("hr"),e._v(" "),s("p",[s("em",[e._v("以上，就学习了 GridFS在 SpringBoot 中的基本使用方法")])]),e._v(" "),s("hr"),e._v(" "),s("blockquote",[s("p",[e._v("扩充\n"),s("code",[e._v("multer-gridfs-storage")]),e._v("：Mul GridFS存储引擎，用于Multer将上传的文件直接存储到MongoDb"),s("a",{attrs:{href:"https://github.com/devconcept/multer-gridfs-storage",target:"_blank",rel:"noopener noreferrer"}},[e._v("GitHub - devconcept/multer-gridfs-storage"),s("OutboundLink")],1),e._v(" "),s("code",[e._v("gridfs-stream")]),e._v("：轻松将文件流式传输到MongoDB GridFS和从MongoDB GridFS流式传输文件。"),s("a",{attrs:{href:"https://github.com/aheckmann/gridfs-stream",target:"_blank",rel:"noopener noreferrer"}},[e._v("GitHub - aheckmann/gridfs-stream"),s("OutboundLink")],1)])]),e._v(" "),s("blockquote",[s("p",[e._v("GridFS也有一些问题，\n比如它读取文件的性能并不是很好，因为我们需要查询两次集合（先是fs.files，再是fs.chunks）才能将文件拼凑出来。\n如果我们的文件需要经常修改，那么GridFS也不合适，因为GridFS没法修改单独的某个分块，要修改文件的话，需要先将该文件删除，然后重新上传。")])])])}),[],!1,null,null,null);s.default=t.exports}}]);